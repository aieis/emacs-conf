#+TITLE: MYINIT
#+AUTHOR: aieis
* Bootstrap
** Package Repositories
   #+BEGIN_SRC emacs-lisp
     (defvar bootstrap-version)
     (let ((bootstrap-file
	    (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
	   (bootstrap-version 6))
       (unless (file-exists-p bootstrap-file)
	 (with-current-buffer
	     (url-retrieve-synchronously
	      "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
	      'silent 'inhibit-cookies)
	   (goto-char (point-max))
	   (eval-print-last-sexp)))
       (load bootstrap-file nil 'nomessage))
     (setq-default straight-use-package-by-default t)
     (straight-use-package 'use-package)
     (use-package org :straight (:type built-in))
   #+END_SRC
* Defaults
** Default Options
   #+BEGIN_SRC emacs-lisp
     (column-number-mode t)
     (setq display-buffer-base-action '(display-buffer-reuse-window (reusable-frames . 1)))
     (setq menu-bar-mode nil)
     (setq tool-bar-mode nil)
     (setq display-line-numbers-type t)
     (global-display-line-numbers-mode t)
     (set-scroll-bar-mode nil)
     (global-auto-revert-mode t)
     (global-hl-line-mode t)
     (blink-cursor-mode 0)
     (setq-default truncate-lines t)
     (setq-default indent-tabs-mode nil)
     (electric-pair-mode 1)
     (setq delete-old-versions t)
     (recentf-mode 1)
     (setq native-comp-async-report-warnings-errors 'silent)
     (setq org-startup-indented t)
     (setq org-hide-leading-stars t)
   #+END_SRC

** Font
#+BEGIN_SRC emacs-lisp
  (setq aieis/font-family "Iosevka")
  (setq aieis/font-size 10)
  (setq aieis/font-list '(("Iosevka" . 10)))

  (defun frame-font-setup
      (&rest ...)
    ;; (remove-hook 'focus-in-hook #'frame-font-setup)
    (unless (assoc 'font default-frame-alist)
      (let* ((font-a (catch 'break
                       (dolist (font-a aieis/font-list)
                         (when (member (car font-a) (font-family-list))
                           (throw 'break font-a)))))
             (font (when (car font-a) (format "%s-%d" (car font-a) (cdr font-a)))))
        (when font
          (add-to-list 'default-frame-alist (cons 'font font))
          (set-frame-font font t t)))))
  (add-hook 'focus-in-hook #'frame-font-setup)
#+END_SRC
   
** Bell
#+BEGIN_SRC emacs-lisp
  (defun aieis/terminal-visible-bell ()
    "A friendlier visual bell effect."
    (invert-face 'mode-line)
    (run-with-timer 0.1 nil 'invert-face 'mode-line))

  (setq visible-bell nil
        ring-bell-function 'aieis/terminal-visible-bell)
#+END_SRC

* packages
#+BEGIN_SRC emacs-lisp
  (setq aieis/packages
        '(marginalia
          consult
          embark
          embark-consult
          orderless
          ace-window
          vertico
          transpose-frame

          haskell-mode
          rust-mode

          lsp-mode
          lsp-ui
          lsp-haskell
          lsp-pyright

          all-the-icons
          all-the-icons-dired
          dired-hide-dotfiles ))
#+END_SRC
* Install Packages
#+BEGIN_SRC emacs-lisp
  (defun aieis/install-packages ()
      (interactive)
      (dolist (package aieis/packages)
        (straight-use-package package)))
  (aieis/install-packages)
#+END_SRC
  
* Load Custom Files
#+BEGIN_SRC emacs-lisp
  (add-to-list 'load-path (concat user-emacs-directory "lisp/" ))
  (load "utils")
  (load "read-only-enhanced")
  (load "filemanager")
  (load "sys-utils")
  (load "proglang")
 #+END_SRC
* Undo Tree
   #+BEGIN_SRC emacs-lisp
     ;; (use-package undo-tree
     ;;   :init
     ;;   (setq undo-tree-history-directory-alist '(("." . "~/.emacs.d/undo")))
     ;;   :config
     ;;   (global-undo-tree-mode))
   #+END_SRC
   
* Org Mode
  #+BEGIN_SRC emacs-lisp
    (load "agenda")
    (use-package org
      :config
      (define-key global-map (kbd "C-c a") 'aieis/org-agenda)
      (define-key global-map (kbd "C-c c") 'org-capture))

    (use-package org-roam
      :straight t
      :custom
      (org-roam-directory (file-truename "~/notes"))
      :bind (("C-c n l" . org-roam-buffer-toggle)
             ("C-c n f" . org-roam-node-find)
             ("C-c n g" . org-roam-graph)
             ("C-c n i" . org-roam-node-insert)
             ("C-c n c" . org-roam-capture)
             ("C-c n j" . org-roam-dailies-capture-today))
      :config
      ;; If you're using a vertical completion framework, you might want a more informative completion interface
      ;;(setq org-roam-node-display-template (concat "${title:*} " (propertize "${tags:10}" 'face 'org-tag)))
      (org-roam-db-autosync-mode)
      ;; If using org-roam-protocol
      (require 'org-roam-protocol))

    (with-eval-after-load 'org
      (setq org-capture-templates
            `(("b"
               "Template for adding a task"
               entry
               (file+headline "~/notes/tasks.org" "Refile")
               "* TODO %^t %? %^G")
              ("a"
               "Template for adding a task"
               entry
               (file+headline "~/notes/art.org" "Art")
               "* TODO %^t %?  %^G")
              ("c" "Add a code snippet" entry
               (file+headline "~/notes/snippets.org" "Snippet")
               "* %t %?"))))
  #+END_SRC
* Eglot . Company
#+BEGIN_SRC emacs-lisp
  (use-package company
    :init
    (setq company-selection-wrap-around t)
    :config
    (global-company-mode))
  
#+END_SRC
* COMMENT Completions
  #+BEGIN_SRC emacs-lisp
    (setq completions-format 'one-column)
    (defun aieis/in-completions ()
      (string-match-p "\\*Completions\\*" (buffer-name)))

    (defun aieis/next-completion ()
      (interactive)
      (if (aieis/in-completions)
          (if (eobp)
              (when-let ((mini (active-minibuffer-window))) (select-window mini))
            (next-completion 1))))

    (defun aieis/prev-completion ()
      (interactive)
      (if (aieis/in-completions)
          (if (bobp)
              (when-let ((mini (active-minibuffer-window))) (select-window mini))
          (next-completion -1))))

    (defun aieis/switch-to-completions-top ()
      (interactive)
      (switch-to-completions)
      (goto-line 1)
      (next-completion 1))

    (defun aieis/switch-to-completions-bot ()
      (interactive)
      (aieis/switch-to-completions-top)
      (next-completion -1))

    (define-key minibuffer-local-map (kbd "C-n") 'aieis/switch-to-completions-top)
    (define-key minibuffer-local-map (kbd "C-p") 'aieis/switch-to-completions-bot)
    (define-key completion-list-mode-map (kbd "C-n") 'aieis/next-completion)
    (define-key completion-list-mode-map (kbd "C-p") 'aieis/prev-completion)

  #+END_SRC

* Embark . Consult . Orderless . Marginalia
  #+BEGIN_SRC emacs-lisp
    (use-package orderless
      :custom (completion-styles '(orderless basic))
      (completion-category-overrides '((file (styles basic partial-completion)))))

    (use-package marginalia
      :config
      (marginalia-mode))

    (use-package embark
      :config
      (define-key global-map (kbd "C-;") #'embark-act)
      (define-key minibuffer-local-map (kbd "C-'") #'embark-collect-live)
      (define-key minibuffer-local-map (kbd "C-,") #'embark-become))

    (use-package consult
      :config
      (consult-customize consult-theme :preview-key '(:debounce 0.5 any)))

    (use-package embark-consult)

  #+END_SRC

* Vertico
#+BEGIN_SRC emacs-lisp
  (use-package vertico
    :init
    (vertico-mode))

  ;; Persist history over Emacs restarts. Vertico sorts by history position.
  (use-package savehist
    :init
    (savehist-mode))
#+END_SRC
* magit
#+BEGIN_SRC emacs-lisp
  (use-package magit)
#+END_SRC
* Editing Functions
  #+BEGIN_SRC emacs-lisp
    (defun aieis/insert-line-below ()
      (interactive)
      (progn
        (move-end-of-line 1)
        (electric-newline-and-maybe-indent)))

    (defun aieis/insert-line-above ()
      (interactive)
      (progn
        (move-beginning-of-line 1)
        (open-line 1)))


    (defun aieis/kill-line-zero-space ()
      (interactive)
      (progn
        (kill-line)
        (just-one-space 0)
        (indent-for-tab-command)))

    (defun aieis/sudo-find-file (file)
      "Open FILE as root."
      (interactive
       (list (read-file-name "Open as root: ")))
      (find-file (if (file-writable-p file)
                     file
                   (concat "/sudo:root@localhost:" file))))
  #+END_SRC

* Help Functions
#+BEGIN_SRC emacs-lisp
  (require 'thingatpt)

  (defun aieis/man-b (&optional target)
    (interactive)
    (let* ((frame (aieis/ensure-visible-frame-pattern "\\*Man .*\\*" "*Man Pages*"))
           (window (frame-first-window frame))
           (buf (if target (man target) (call-interactively 'man)))
           (nwindow (get-buffer-window buf)))
      (unless (eq window nwindow)
        (progn
          (delete-window nwindow)
          (set-window-buffer window buf)))))


  (defun aieis/man ()
    (interactive)
    (aieis/man-b 'nil))

  (defun aieis/man-at-point ()
    (interactive)
    (let ((target (symbol-at-point)))
      (aieis/man-b (symbol-name target))))
#+END_SRC

* File Backups
  #+BEGIN_SRC emacs-lisp
    (setq backup-directory-alist '(("" . "~/.emacs.d/backup/")))
    (setq auto-save-file-name-transforms `((".*" "~/.emacs.d/saves/" t)))
    (setq lock-file-name-transforms `((".*" "~/.emacs.d/lockfiles/" t)))
  #+END_SRC
* Keymap
** Keyboard Keys
  #+BEGIN_SRC emacs-lisp
    (define-key global-map (kbd "C-M-j") #'aieis/insert-line-below)
    (define-key global-map (kbd "C-M-o") #'aieis/insert-line-above)
    (define-key global-map (kbd "C-k") #'aieis/kill-line-zero-space)
    (define-key global-map (kbd "M-]") #'aieis/man-at-point)
  #+END_SRC
** Window Movement
#+BEGIN_SRC emacs-lisp
  (define-key global-map (kbd "M-j") 'other-window)
  (define-key global-map (kbd "M-k") 'myprevious-window)
  (define-key global-map (kbd "M-J") 'delete-other-windows)

  (defun aieis/enlarge-window (&optional DELTA)
    (interactive)
    (or DELTA (setq DELTA 1))
    (enlarge-window (* DELTA 20)))

  (defun myprevious-window ()
      (interactive)
      (other-window -1))
#+END_SRC
* Window Display
** Window
   #+BEGIN_SRC emacs-lisp
     (use-package ace-window
       :ensure t
       :config
       (global-set-key (kbd "M-o") 'ace-window)
       (setq aw-keys '(?a ?s ?d ?f ?g ?h ?j ?k ?l))
       (setq aw-background nil))

   #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (let ((add-display-buffer-alist
           `(
             ("\\*.*shell\\*"
              (display-buffer-reuse-mode-window display-buffer-in-direction)
              (direction . right))	 
             ("\\*.*[C|c]ompilation.*\\*"
              (display-buffer-reuse-mode-window display-buffer-in-side-window)
              (side . right))
             ("\\*Embark Actions\\*"
              (display-buffer-reuse-mode-window display-buffer-at-bottom)
              (window-height . fit-window-to-buffer)
              (window-parameters . ((no-other-window . t)
                                    (mode-line-format . none))))
             ("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
              nil
              (window-parameters (mode-line-format . none)))
             ("\\*Man .*"
              (display-buffer-reuse-mode-window)
              (reusable-frames . visible))
             ("\\(\\*Agenda Commands.*\\|*Org Agenda.*\\)"
              (display-buffer-reuse-mode-window)
              (reusable-frames . visible)))))
      (setq display-buffer-alist (append display-buffer-alist add-display-buffer-alist)))
   #+END_SRC
   
#+END_SRC
* Themes
#+BEGIN_SRC emacs-lisp
  (use-package moe-theme)
  (use-package modus-themes)
#+END_SRC
